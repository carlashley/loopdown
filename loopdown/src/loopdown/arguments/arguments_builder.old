import argparse

from pathlib import Path

from .arg_formatters import QuotedChoicesHelpFormatter
from .arg_helpers import AutoChoices, CachingServer, MirrorServer
from .arg_parser import StrictArgumentParser
from .arg_sentinels import AUTO, MISSING
from ..consts.apple_enums import ApplicationConsts
from ..consts.config_consts import ConfigurationConsts
from ..consts.version_enums import VersionInfo


def build_arguments() -> argparse.Namespace:
    """Build arguments for command line use."""

    p = StrictArgumentParser(
        description=(
            "Process additional content for Apple's audio applications, GarageBand, Logic Pro, and MainStage.\n"
            "Unless otherwise specified by the '--download-only' argument, content will be installed by default.\n"
            f"Licensed under the {VersionInfo.LICENSE_STRING}"
        ),
        epilog=VersionInfo.VERSION_STRING,
        formatter_class=QuotedChoicesHelpFormatter,
    )
    og = p.add_any_required_group("required flags (at least one)")
    eg = p.add_exclusive_group("optional flags (only one is allowed)")
    dg = p.add_exclusive_group("action flags (only one is allowed)")

    p.add_argument(
        "-n",
        "--dry-run",
        action="store_true",
        dest="dry_run",
        required=False,
        help="perform a dry run; no mutating action taken",
    )

    # p.add_argument(
    #     "-a",
    #     "--apps",
    #     action=AutoChoices,
    #     allowed=ApplicationConsts.SHORT_NAMES,
    #     const=AUTO,
    #     default=None,
    #     dest="applications",
    #     metavar="app|empty",
    #     nargs="*",
    #     help=(
    #         "application to install packages for; when no application specified, installs packages for "
    #         "any valid Apple audio application; choices are %(choices)s"
    #     ),
    # )
    p.add_argument(
        "-a",
        "--apps",
        default=ApplicationConsts.SHORT_NAMES,
        dest="applications",
        metavar="app",
        nargs="*",
        help=(
            "application to install packages for; when no application specified, installs packages for "
            "any valid Apple audio application; choices are %(choices)s; default is %(default)s"
        ),
    )

    p.add_argument(
        "-d",
        "--dest",
        default=ConfigurationConsts.DEFAULT_DOWNLOAD_DEST,
        dest="destination",
        metavar="[dir]",
        required=False,
        type=Path,
        help="override the download directory path when '--download-only' used; default is %(default)s",
    )

    p.add_argument(
        "-l",
        "--log-level",
        choices=["critical", "error", "warning", "info", "debug", "notset"],
        default="info",
        dest="log_level",
        metavar="[level]",
        required=False,
        help="override the log level; default is %(default)s, choices are %(choices)s",
    )

    p.add_argument(
        "-q", "--quiet",
        action="store_true",
        dest="quiet",
        help="all console output (stdout/stderr) is suppressed; events logged to file only",
        required=False,
    )

    p.add_argument(
        "--log-file",
        default=ConfigurationConsts.DEFAULT_LOG_DIRECTORY.joinpath(ConfigurationConsts.DEFAULT_LOG_FILE),
        dest="log_file",
        metavar="[filepath]",
        required=False,
        type=Path,
        help=argparse.SUPPRESS,
    )

    p.add_argument(
        "-v",
        "--version",
        action="version",
        dest="version",
        version=VersionInfo.VERSION_STRING,
    )

    og.add_argument(
        "-r",
        "--req",
        action="store_true",
        dest="required",
        help="include the required audio packages for install",
    )
    og.add_argument(
        "-o",
        "--opt",
        action="store_true",
        dest="optional",
        help="include the optional audio packages for install"
    )

    eg.add_argument(
        "-c",
        "--cache-server",
        action=CachingServer,
        const=AUTO,
        dest="cache_server",
        metavar="url|empty",
        nargs="?",
        required=False,
        help=(
            "use a caching server; when no server is specified, attempts to auto detect; expected format is "
            "'http://ipaddr:port'"
        ),
    )

    eg.add_argument(
        "-m",
        "--mirror-server",
        action=MirrorServer,
        const=MISSING,  # flag missing when not provided so only check for argument value when provided
        dest="mirror_server",
        metavar="[url|empty]",
        nargs="?",
        required=False,
        help="local mirror server to use; expected format is 'https://example.org'",
    )

    dg.add_argument(
        "--download-only",
        action="store_true",
        dest="download_only",
        required=False,
        help=(
            "downloads all content packages specified for later re-use; use '-d/--dest [dir]' to "
            f"override default directory '{ConfigurationConsts.DEFAULT_DOWNLOAD_DEST}'"
        ),
    )

    dg.add_argument(
        "--force-install",
        action="store_true",
        dest="force_install",
        required=False,
        help="force install of all audio content regardless of install state",
    )

    parsed_args = p.parse_args()

    return parsed_args
